{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{% static 'images/janatewifi-logo.jpg' %}" type="image/png">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script defer src="{% static 'js/main.js' %}"></script>
    <title>Stock Market App</title>
    <style>
        .stockmarketdata {
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            width: 80%;
            margin: auto;
        }

        .stockmarketdata td,
        .stockmarketdata th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .stockmarketdata tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .stockmarketdata tr:hover {
            background-color: #ddd;
        }

        .stockmarketdata th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #04AA6D;
            color: white;
        }

        h2,
        h3 {
            text-align: center;
        }

        #myChart {
            overflow: scroll;
        }

        td a {
            display: inline-block;
            text-decoration: none;
            color: white;
            padding: 10px;
            border-radius: 4px;
        }

        a.update {
            background-color: green;
        }

        a.delete {
            background-color: red;
        }
    </style>
</head>

<body>

    <div class="topnav" id="myTopnav">
        <a href="{%url 'stockmarketapp:homepage' %}" class="active">Home</a>
        <a href="{%url 'stockmarketapp:add_data' %}">Add Data</a>
    </div>

    <h2>Stock Market App</h2>
    <h3>Chart</h3>

    <div class="chart-controls">
        <div class="trade-container">
            <select class="dropdown" id="trade_codes" onchange="changeLineColumn()">

                {% for trade_code in trade_codes%}
                <option value="{{ trade_code }}" {% if forloop.first %} selected {% endif %}>{{ trade_code }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="show-bar">
            <button onclick="toggleVolume()">Show Volume Bar</button>
        </div>
    </div>


    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>


    <h3>Table Visualization</h3>
    <table class="stockmarketdata">
        <tr>
            <th>No.</th>
            <th>Date</th>
            <th>Trade Code</th>
            <th>High</th>
            <th>Low</th>
            <th>Open</th>
            <th>Close</th>
            <th>Volume</th>
            <th>Action</th>
        </tr>


    </table>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script>





        let chartData, close_values, trade_code, volume, date;
        const config = {

            options: {
                scales: {
                    // Can configure scaling here
                },
                maintainAspectRatio: false
            }
        };
        const ctx = document.getElementById('myChart').getContext('2d');

        // Rendering the chart
        let stockChart;

        let hideVolume = true;


        function drawChart() {

            const trade_code = document.getElementById("trade_codes").value


            $.ajax({
                method: 'GET',
                url: `chart-data/${trade_code}`,
                success: function (responeData) {
                    close_values = responeData.close;
                    volume = responeData.volume;
                    date = responeData.date;
                    open_values = responeData.open;
                    high = responeData.high;
                    low = responeData.low;
                    ids = responeData.id;
                    let table = document.querySelector(".stockmarketdata")
                    $(".stockmarketdata tr>td").remove();
                    for (let i = 0; i < ids.length; i++) {

                        let row = table.insertRow(i + 1)
                        let id_cell = row.insertCell(0),
                            date_cell = row.insertCell(1),
                            trade_cell = row.insertCell(2),
                            high_cell = row.insertCell(3),
                            low_cell = row.insertCell(4),
                            open_cell = row.insertCell(5),
                            close_cell = row.insertCell(6),
                            volume_cell = row.insertCell(7),
                            action_cell = row.insertCell(8);

                        id_cell.innerHTML = ids[i]
                        date_cell.innerHTML = date[i]
                        trade_cell.innerHTML = trade_code
                        high_cell.innerHTML = high[i]
                        low_cell.innerHTML = low[i]
                        open_cell.innerHTML = open_values[i]
                        close_cell.innerHTML = close_values[i]
                        volume_cell.innerHTML = volume[i]
                        action_cell.innerHTML = `<a class="update" href="dataform/${ids[i]}"> Update </a> <a class="delete" href="delete/${ids[i]}"> Delete </a>`



                    }

                    const volumeBarDataset =
                        config.data = {
                            labels: date,
                            datasets: [
                                {
                                    type: 'line',
                                    label: 'Close Line Chart',
                                    backgroundColor: 'rgb(255, 99, 132)',
                                    borderColor: 'rgb(255, 99, 132)',
                                    data: close_values,
                                },
                                {
                                    type: 'bar',
                                    label: 'Volume Bar Chart',
                                    backgroundColor: 'rgb(0,128,0)',
                                    borderColor: 'rgb(0,128,0)',
                                    data: volume
                                }
                            ],

                        };

                    if (hideVolume === true) {
                        config.data.datasets.pop()
                    }


                    stockChart = new Chart(
                        ctx,
                        config
                    );

                },
                error: function (error) {
                    console.log(`Error: ${error}`)
                }
            })



        }
        let showBar = false
        function toggleVolume() {
            if (!showBar) {
                showBar = true
                hideVolume = false
                stockChart.destroy()
                drawChart();
                document.querySelector('.chart-container').style.height = '500px'
                document.querySelector('.show-bar button').innerHTML = "Hide Volume Bar"

            }
            else {
                showBar = false
                hideVolume = true
                stockChart.destroy()
                drawChart();
                document.querySelector('.chart-container').style.height = '300px'
                document.querySelector('.show-bar button').innerHTML = "Show Volume Bar"
            }
        }

        function changeLineColumn() {
            if (typeof (stockChart) != "undefined") stockChart.destroy()
            drawChart()
        }
        drawChart()

    </script>
</body>

</html>